# SPDX-License-Identifier: FSFAP
# SPDX-FileCopyrightText: SW360 Community
# Sample Apache config to use Mellon with SAML and provide authentication for
# Grafana dashboard.

Listen 8443 https

<VirtualHost _default_:8443>
    <Location /dashboard>
        ProxyPass http://127.0.0.1:3000
        ProxyPassReverse http://127.0.0.1:3000
        ProxyErrorOverride off
        ProxyPreserveHost On
        RequestHeader set Host %{HTTP_HOST}s
        Order allow,deny
        Allow from all
        #MellonEnable "off"
        MellonEnable "auth"
        MellonSecureCookie On
        MellonSessionLength 43200
        MellonVariable entitlement
        MellonCookieDomain sw360.org

        # MellonDefaultLoginPath is the location where one should be
        # redirected after an IdP-initiated login. Default is "/"
        ## Default: MellonDefaultLoginPath "/"
        MellonDefaultLoginPath "/dashboard"
        MellonPostReplay On

        MellonSPPrivateKeyFile /etc/apache2/mellon/sw360.key
        MellonSPCertFile       /etc/apache2/mellon/sw360.cert
        MellonSPMetadataFile   /etc/apache2/mellon/sw360.xml
        MellonIdPMetadataFile  /etc/apache2/mellon/idp-sw360.xml

        MellonEndpointPath /saml

        RequestHeader set Mellon-Email %{MELLON_EMAIL}e
        RequestHeader set Mellon-Surname %{MELLON_FAMILYNAME}e
        RequestHeader set Mellon-Givenname %{MELLON_GIVENNAME}e
        RequestHeader set Mellon-Orgcode %{MELLON_ORGCODE}e
        RequestHeader set Mellon-Name "%{MELLON_GIVENNAME}e %{MELLON_FAMILYNAME}e"

    </Location>
    <Location /dashboard/api/live>
        ProxyPass http://127.0.0.1:3000
        ProxyPassReverse http://127.0.0.1:3000

        ProxyPreserveHost On
        RequestHeader set Host %{HTTP_HOST}s
        RequestHeader set Connection "upgrade"
        RequestHeader set Upgrade %{HTTP_UPGRADE}s
        Order allow,deny
        Allow from all
        Order allow,deny
        Allow from all
        MellonEnable "off"
        #MellonEnable "auth"
    </Location>

</VirtualHost>
